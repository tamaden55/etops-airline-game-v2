# ETOPS Flight Planner 開発ジャーナル

## 2025-07-10 作業内容

### 完成した機能
1. **バックエンドロジック**
   - ETOPSCalculator クラス (`etops-calculator.js`)
   - 球面三角法による距離計算（Haversine公式）
   - ETOPS計算ロジック、代替空港検索
   - ルーティング計算機能

2. **データベース**
   - 機材データ (`data/aircraft.json`) - 42機種の双発機
   - 空港データ (`data/airports.json`) - 25の主要空港と代替空港

3. **フロントエンド**
   - HTML/CSS - 航空業界風ダークテーマUI
   - Leaflet.js による地図表示
   - 機材選択、空港選択、ルート計算機能

### 未解決の重要問題
**太平洋横断ルート表示の異常**
- 成田→LAX路線で地図上に不自然なルートが表示される
- 大西洋経由の長距離ルートが描画されてしまう
- 距離計算は正しい（4,726nm vs 実際4,737nm）
- ウェイポイント座標も正しい（北太平洋大圏ルート）

### 問題の調査結果
1. **距離計算**: ✅ 正しい
   - NRT-LAX: 計算値4,726nm ≈ 実際値4,737nm
   - 日付変更線を考慮したHaversine公式で正確

2. **ウェイポイント生成**: ✅ 正しい
   - 球面線形補間（SLERP）で正しい大圏コースを計算
   - 日付変更線通過も適切に処理

3. **座標データ**: ✅ 正しい
   - NRT: 35.7647°N, 140.3864°E
   - LAX: 33.9425°N, 118.4081°W

### 試行した解決策
1. 日付変更線対応の座標正規化 → 過度な補正で逆効果
2. Leaflet設定変更（worldCopyJump等） → 効果なし
3. 球面補間の改良 → 計算は正しいが表示問題残存

## 明日への引き継ぎ事項

### 優先課題
**🔥 太平洋横断ルート表示問題の解決**

### 推定原因と対策
1. **Leafletでの日付変更線処理**
   - 現在の座標 [lat, lng] をそのまま渡している
   - Leafletが内部で日付変更線を誤認識している可能性

2. **解決アプローチ案**
   ```javascript
   // Option A: 座標の明示的な正規化
   const normalizedCoords = normalizeForLeaflet(routeCoords);
   
   // Option B: 複数のポリラインに分割
   const segments = splitAtAntimeridian(routeCoords);
   
   // Option C: 代替地図ライブラリの検討
   // Mapbox GL JS等でのテスト
   ```

3. **デバッグ方法**
   - ブラウザコンソールで座標確認
   - 手動で太平洋ルートの座標を設定してテスト
   - 段階的にウェイポイント数を減らして問題箇所特定

### 現在のファイル構成
```
etops-airline-game-v2/
├── index.html              # メインHTMLファイル
├── styles.css              # ダークテーマCSS
├── app.js                  # フロントエンドアプリ
├── etops-calculator.js     # ETOPSエンジン
├── test-etops.js           # テストスクリプト
├── debug-distance.js       # 距離計算デバッグ
├── debug-waypoints.js      # ウェイポイントデバッグ
├── data/
│   ├── aircraft.json       # 機材データ（42機種）
│   └── airports.json       # 空港データ（25空港）
└── specifications.md       # 仕様書
```

### テスト方法
```bash
# ローカルサーバー起動
python3 -m http.server 8000

# バックエンドテスト
node test-etops.js
node debug-waypoints.js

# ブラウザでアクセス
http://localhost:8000
```

### 備考
- 機能的には90%完成
- 主要な問題は地図表示のみ
- ビジネスロジックは全て正常動作
- UIデザインは航空マニア向けに最適化済み

---
**次回作業開始時**: まず debug-waypoints.js で座標確認、その後フロントエンドの表示ロジックを重点的に修正

## 文字化け問題について
**発生原因**: ファイル保存時の文字エンコーディングの問題
**対策**: UTF-8で明示的に保存し直すこと

---

## 2025-07-11 作業再開

### 開始時点の状況確認
- ✅ バックエンド計算は正確（NRT-LAX: 4,726nm ≈ 実際4,737nm）
- ✅ ウェイポイント生成も正しい北太平洋大圏ルート
- ❌ **主要課題**: Leaflet.jsでの太平洋横断ルート表示が不自然

### 10:30 - 解決アプローチの実装開始
**試行するアプローチ**: Option B - 複数ポリラインに分割
- `splitRouteAtAntimeridian()` 関数を実装
- 日付変更線での経度ジャンプ（>180度）を検出
- ルートを複数セグメントに分割して個別描画

**実装内容**:
- `displayRoute()` 関数を修正
- デバッグログを追加（コンソールで座標確認可能）
- アンチメリディアン交差の検出・分割ロジック

### 10:45 - 地図中心とルート表示の改良
**問題**: ルートセグメント分割により経路線が断絶
**解決策**: 太平洋横断ルート専用の処理を実装

**実装内容**:
1. `fitMapToRoute()` 関数を改良
   - 太平洋横断ルート検出（経度差>180度）
   - 地図中心を太平洋に移動
   - 適切なズームレベルと境界設定

2. `normalizeTranspacificCoords()` 関数を追加
   - 負の経度を正の経度に変換（360度加算）
   - 太平洋上で連続したルート表示を実現

3. 条件分岐による表示方式の選択
   - 太平洋横断: 座標正規化 + 単一ポリライン
   - 通常ルート: セグメント分割 + 複数ポリライン

### 11:00 - 地図重複表示問題の修正
**問題**: 太平洋中心表示時に世界地図が重複表示
**解決策**: 地図境界とマーカー座標の統一

**実装内容**:
1. 地図初期化設定を調整
   - `worldCopyJump: false` で重複防止
   - `maxBounds` を拡張して太平洋表示対応

2. マーカー座標の正規化
   - 出発・到着マーカーも座標変換対象
   - 太平洋横断時の一貫した座標系使用

3. 境界設定の最適化
   - 太平洋特化の境界範囲（100°〜280°）
   - 世界地図の重複回避

### 11:15 - ユーザビリティの改善
**改良内容**: 機材選択時のETOPS情報表示強化

**実装内容**:
1. 機材選択リストにETOPS性能を追加表示
   - 各機材名にETOPS時間を併記
   - カテゴリ名にETOPS範囲を表示
   - 性能による機材分類の明確化

2. 機材情報パネルの拡張
   - "ETOPS Distance"項目を追加
   - 時間×巡航速度でETOPS距離を自動計算
   - より直感的な性能理解をサポート

**UI改善効果**:
- ユーザーが機材のETOPS能力を一目で把握可能
- 路線に適した機材選択の判断材料を提供
- 航空専門知識の学習促進