# ETOPS Flight Planner 開発ジャーナル

## 2025-07-10 作業内容

### 完成した機能
1. **バックエンドロジック**
   - ETOPSCalculator クラス (`etops-calculator.js`)
   - 球面三角法による距離計算（Haversine公式）
   - ETOPS計算ロジック、代替空港検索
   - ルーティング計算機能

2. **データベース**
   - 機材データ (`data/aircraft.json`) - 42機種の双発機
   - 空港データ (`data/airports.json`) - 25の主要空港と代替空港

3. **フロントエンド**
   - HTML/CSS - 航空業界風ダークテーマUI
   - Leaflet.js による地図表示
   - 機材選択、空港選択、ルート計算機能

### 未解決の重要問題
**太平洋横断ルート表示の異常**
- 成田→LAX路線で地図上に不自然なルートが表示される
- 大西洋経由の長距離ルートが描画されてしまう
- 距離計算は正しい（4,726nm vs 実際4,737nm）
- ウェイポイント座標も正しい（北太平洋大圏ルート）

### 問題の調査結果
1. **距離計算**: ✅ 正しい
   - NRT-LAX: 計算値4,726nm ≈ 実際値4,737nm
   - 日付変更線を考慮したHaversine公式で正確

2. **ウェイポイント生成**: ✅ 正しい
   - 球面線形補間（SLERP）で正しい大圏コースを計算
   - 日付変更線通過も適切に処理

3. **座標データ**: ✅ 正しい
   - NRT: 35.7647°N, 140.3864°E
   - LAX: 33.9425°N, 118.4081°W

### 試行した解決策
1. 日付変更線対応の座標正規化 → 過度な補正で逆効果
2. Leaflet設定変更（worldCopyJump等） → 効果なし
3. 球面補間の改良 → 計算は正しいが表示問題残存

## 明日への引き継ぎ事項

### 優先課題
**🔥 太平洋横断ルート表示問題の解決**

### 推定原因と対策
1. **Leafletでの日付変更線処理**
   - 現在の座標 [lat, lng] をそのまま渡している
   - Leafletが内部で日付変更線を誤認識している可能性

2. **解決アプローチ案**
   ```javascript
   // Option A: 座標の明示的な正規化
   const normalizedCoords = normalizeForLeaflet(routeCoords);
   
   // Option B: 複数のポリラインに分割
   const segments = splitAtAntimeridian(routeCoords);
   
   // Option C: 代替地図ライブラリの検討
   // Mapbox GL JS等でのテスト
   ```

3. **デバッグ方法**
   - ブラウザコンソールで座標確認
   - 手動で太平洋ルートの座標を設定してテスト
   - 段階的にウェイポイント数を減らして問題箇所特定

### 現在のファイル構成
```
etops-airline-game-v2/
├── index.html              # メインHTMLファイル
├── styles.css              # ダークテーマCSS
├── app.js                  # フロントエンドアプリ
├── etops-calculator.js     # ETOPSエンジン
├── test-etops.js           # テストスクリプト
├── debug-distance.js       # 距離計算デバッグ
├── debug-waypoints.js      # ウェイポイントデバッグ
├── data/
│   ├── aircraft.json       # 機材データ（42機種）
│   └── airports.json       # 空港データ（25空港）
└── specifications.md       # 仕様書
```

### テスト方法
```bash
# ローカルサーバー起動
python3 -m http.server 8000

# バックエンドテスト
node test-etops.js
node debug-waypoints.js

# ブラウザでアクセス
http://localhost:8000
```

### 備考
- 機能的には90%完成
- 主要な問題は地図表示のみ
- ビジネスロジックは全て正常動作
- UIデザインは航空マニア向けに最適化済み

---
**次回作業開始時**: まず debug-waypoints.js で座標確認、その後フロントエンドの表示ロジックを重点的に修正

## 文字化け問題について
**発生原因**: ファイル保存時の文字エンコーディングの問題
**対策**: UTF-8で明示的に保存し直すこと

---

## 2025-07-11 作業再開

### 開始時点の状況確認
- ✅ バックエンド計算は正確（NRT-LAX: 4,726nm ≈ 実際4,737nm）
- ✅ ウェイポイント生成も正しい北太平洋大圏ルート
- ❌ **主要課題**: Leaflet.jsでの太平洋横断ルート表示が不自然

### 10:30 - 解決アプローチの実装開始
**試行するアプローチ**: Option B - 複数ポリラインに分割
- `splitRouteAtAntimeridian()` 関数を実装
- 日付変更線での経度ジャンプ（>180度）を検出
- ルートを複数セグメントに分割して個別描画

**実装内容**:
- `displayRoute()` 関数を修正
- デバッグログを追加（コンソールで座標確認可能）
- アンチメリディアン交差の検出・分割ロジック

### 10:45 - 地図中心とルート表示の改良
**問題**: ルートセグメント分割により経路線が断絶
**解決策**: 太平洋横断ルート専用の処理を実装

**実装内容**:
1. `fitMapToRoute()` 関数を改良
   - 太平洋横断ルート検出（経度差>180度）
   - 地図中心を太平洋に移動
   - 適切なズームレベルと境界設定

2. `normalizeTranspacificCoords()` 関数を追加
   - 負の経度を正の経度に変換（360度加算）
   - 太平洋上で連続したルート表示を実現

3. 条件分岐による表示方式の選択
   - 太平洋横断: 座標正規化 + 単一ポリライン
   - 通常ルート: セグメント分割 + 複数ポリライン

### 11:00 - 地図重複表示問題の修正
**問題**: 太平洋中心表示時に世界地図が重複表示
**解決策**: 地図境界とマーカー座標の統一

**実装内容**:
1. 地図初期化設定を調整
   - `worldCopyJump: false` で重複防止
   - `maxBounds` を拡張して太平洋表示対応

2. マーカー座標の正規化
   - 出発・到着マーカーも座標変換対象
   - 太平洋横断時の一貫した座標系使用

3. 境界設定の最適化
   - 太平洋特化の境界範囲（100°〜280°）
   - 世界地図の重複回避

### 11:15 - ユーザビリティの改善
**改良内容**: 機材選択時のETOPS情報表示強化

**実装内容**:
1. 機材選択リストにETOPS性能を追加表示
   - 各機材名にETOPS時間を併記
   - カテゴリ名にETOPS範囲を表示
   - 性能による機材分類の明確化

2. 機材情報パネルの拡張
   - "ETOPS Distance"項目を追加
   - 時間×巡航速度でETOPS距離を自動計算
   - より直感的な性能理解をサポート

**UI改善効果**:
- ユーザーが機材のETOPS能力を一目で把握可能
- 路線に適した機材選択の判断材料を提供
- 航空専門知識の学習促進

### 11:30 - GitHub更新完了
**作業完了**: 今日の全ての修正をGitHubにプッシュ

**アップロード内容**:
- 太平洋横断ルート表示問題の完全解決
- UI/UXの大幅改善
- 開発ログの詳細記録

**現在の状況**:
✅ **主要機能**: 100%完成
✅ **太平洋ルート表示**: 問題解決済み
✅ **ETOPS計算**: 正確に動作
✅ **ユーザビリティ**: 航空ファン向けに最適化

**プロジェクト完成度**: 95%
**残課題**: 細かな機能追加・改良のみ

### 11:45 - GitHub Pages対応とREADME更新
**作業内容**: 公開用ドキュメントの整備

**READMEの更新内容**:
1. ライブデモURLを冒頭に追加
2. アクセス方法を「オンライン」「ローカル」に分離
3. 使用方法の詳細説明を追加
4. 開発状況を最新の完成状態に更新
5. 自動デプロイメント機能の説明追加

**公開準備完了**:
- GitHub Pagesで自動デプロイ設定済み
- アクセスURL: https://tamaden55.github.io/etops-airline-game-v2
- mainブランチへのプッシュで自動更新
- 常設ウェブアプリとしての運用開始

### 12:00 - 空港選択UIの改善
**改善内容**: テキスト入力からプルダウン選択への変更

**問題**:
- ユーザーが利用可能な空港を把握できない
- 空港コードの手入力が必要で使いにくい

**実装内容**:
1. HTMLをselect要素に変更
   - departure-airport, arrival-airportを両方プルダウン化
   - 「Select Airport」プレースホルダー追加

2. 空港データの動的読み込み
   - `populateAirportDropdowns()` 関数を実装
   - Major Airports / Alternate Airportsでカテゴリ分け
   - アルファベット順ソート
   - 表示形式: "NRT - 成田国際空港"

3. 計算ロジックの調整
   - プルダウンの値を直接使用
   - 余分な文字列処理を削除

**UI改善効果**:
- ユーザビリティの大幅向上
- 利用可能空港の可視化
- 入力エラーの削減

---

## 2025-07-11 午後セッション - ETOPS視覚警告システムの実装

### 14:30 - セッション再開
**継続課題**: 空港プルダウンの不具合解決
- ユーザー報告: "空港選択プルダウンが機能しない。プルダウン選択肢が表示されない"

### 14:45 - 空港プルダウン問題の解決
**原因調査**:
- デバッグログを追加してDOM要素の存在確認
- 初期化順序とデータ読み込みタイミングの検証

**解決結果**:
✅ **問題解決**: ユーザー確認「Yes, the dropdown boxes work!」
- 空港選択が正常にプルダウン形式で動作
- 19の主要空港 + 6の代替空港が適切に分類表示

### 15:00 - ETOPS視覚警告システムの実装
**ユーザーからの提案**: 
> "このサークルが繋がらなかったら（ETOPS Incompliant)の時には、左のペーンにその表示をするだけではなく、サークルの色を赤くするとかばつを表示するなど、危機を煽ってはどうか"

**実装内容**:
1. **動的サークル色変更**
   - 適合時: オレンジ色 (#f59e0b)
   - 不適合時: 赤色 (#ef4444)
   - より太いボーダーと高い不透明度で警告強調

2. **警告アイコンの追加**
   - 各ウェイポイントに⚠マークアイコン表示
   - 赤い円形背景でアテンション効果
   - ポップアップで詳細警告メッセージ

3. **アニメーション効果**
   - パルス効果で警告アイコンを点滅
   - ボーダーアニメーション（赤⟷黄色）
   - ボタンも警告色に変化

4. **ボタン状態変更**
   - 通常時: "Show ETOPS Areas"
   - 警告時: "⚠ ETOPS Warning Areas" (赤色点滅)

**CSS追加**:
- `@keyframes etops-warning-pulse`
- `@keyframes etops-warning-border`
- `.etops-warning-active` クラス

### 15:30 - 重大なロジック不具合発見
**ユーザー指摘**: 
> "NON-COMPLIANTなのにサークルがつながってしまっている"

**問題の状況**:
- 機材: E175 (120分ETOPS、894nm制限)
- ルート: CDG→NRT (5,243nm)
- 左パネル: 「NON-COMPLIANT」表示 ✅
- 地図表示: オレンジ色サークル表示 ❌ (赤色であるべき)

**調査開始**:
- ETOPS計算ロジックの検証
- `checkETOPSCompliance()` 関数の動作確認
- 視覚表示との同期問題の可能性

**デバッグ実装**:
```javascript
console.log('=== ETOPS AREAS DEBUG ===');
// 詳細な違反調査とウェイポイント別代替空港チェック
```

**発見した手がかり**:
- ルートは11ウェイポイントで構成
- 北極経由の大圏ルート（CDG→NRT）
- 理論的に894nm制限では中間地点で代替空港不足のはず

### 16:00 - セッション中断
**現在の状況**:
❌ **未解決の重要バグ**: ETOPS判定と視覚表示の不一致
- 計算エンジン: NON-COMPLIANT判定 ✅
- 視覚表示: 適合色（オレンジ）で表示 ❌

**次回継続事項**:
1. **Show ETOPS Areas**ボタンのコンソール出力を確認
2. `isCompliant`変数の伝達過程を調査  
3. 視覚表示ロジックの修正
4. 特に北極海上ウェイポイント（WP3-WP6）での代替空港検証

**推定原因**:
- `showETOPSAreas()`関数内で`isCompliant`が正しく反映されていない
- 非同期処理やデータ参照の問題の可能性

**技術メモ**:
- E175: 120分ETOPS = 894nm制限
- CDG→NRT: 5,243nm（約11.7時間飛行）
- 北極経由ルートで代替空港希薄地域を通過

---
**次回作業開始時**: デバッグ出力でETOPS判定と視覚表示の差異を特定し、視覚警告システムを完全動作させる